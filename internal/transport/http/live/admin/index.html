<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brale Admin</title>
  <link rel="stylesheet" href="/admin/app.css" />
  <script src="https://unpkg.com/vue@3.4.21/dist/vue.global.prod.js"></script>
</head>
<body>
  <div id="app">
    <header class="app-header">
      <h1>Brale å®ç›˜ç›‘æ§</h1>
      <div class="actions">
        <button @click="manualRefresh" :disabled="loading">åˆ·æ–°</button>
        <label>
          è‡ªåŠ¨åˆ·æ–°
          <select v-model.number="refreshInterval">
            <option :value="0">å…³é—­</option>
            <option :value="10">10s</option>
            <option :value="30">30s</option>
            <option :value="60">60s</option>
          </select>
        </label>
        <div class="symbol-filter">
          <label>
            äº¤æ˜“å¯¹
            <input
              v-model="symbolInput"
              @keyup.enter="applySymbolFilter"
              placeholder="ä¾‹å¦‚ ETHUSDT"
            />
          </label>
          <button class="ghost" @click="applySymbolFilter">åº”ç”¨</button>
          <button class="ghost" @click="clearSymbolFilter" :disabled="!symbolFilter">æ¸…é™¤</button>
        </div>
        <div class="stage-filter">
          <label>
            é˜¶æ®µ
            <select v-model="stageFilter">
              <option
                v-for="opt in stageOptions"
                :key="opt.value"
                :value="opt.value"
              >
                {{ opt.label }}
              </option>
            </select>
          </label>
        </div>
      </div>
    </header>

    <section class="status-bar">
      <div>
        <strong>å†³ç­–è®°å½•</strong>
        <span>ç¬¬ {{ page }} é¡µ Â· æ¯é¡µ {{ pageSize }} æ¡ Â· {{ symbolFilter || 'å…¨éƒ¨äº¤æ˜“å¯¹' }}</span>
      </div>
      <div>
        <strong>ä»“ä½</strong>
        <span>{{ positions.length }} ä¸ª</span>
      </div>
      <div v-if="error" class="error">{{ error }}</div>
    </section>

    <main class="grid">
      <section class="card traces">
        <div class="card-head">
          <h2>å†³ç­–æµç¨‹</h2>
          <div class="pagination">
            <button class="ghost" @click.stop="prevPage" :disabled="page === 1">ä¸Šä¸€é¡µ</button>
            <span>ç¬¬ {{ page }} é¡µ</span>
            <button class="ghost" @click.stop="nextPage" :disabled="!hasNext">ä¸‹ä¸€é¡µ</button>
          </div>
        </div>
        <div v-if="!traces.length" class="empty">æš‚æ— å®æ—¶å†³ç­–</div>
        <div v-for="trace in traces" :key="trace.trace_id" class="trace">
          <header @click="toggleTrace(trace.trace_id)">
            <div>
              <h3>{{ formatTraceTitle(trace) }}</h3>
              <small>{{ formatTs(trace.ts) }} Â· {{ trace.horizon }}</small>
            </div>
            <button>{{ expanded.has(trace.trace_id) ? 'æ”¶èµ·' : 'å±•å¼€' }}</button>
          </header>
          <transition name="fade">
            <div v-if="expanded.has(trace.trace_id)" class="steps">
              <div class="tab-bar" v-if="trace.steps.length">
                <button
                  class="tab"
                  :class="{ active: !activeTab[trace.trace_id] || activeTab[trace.trace_id] === 'ALL' }"
                  @click.stop="setActiveTab(trace.trace_id, 'ALL')"
                >
                  å…¨éƒ¨
                </button>
                <button
                  v-for="stage in traceStages(trace)"
                  :key="stage.key"
                  class="tab"
                  :class="{ active: activeTab[trace.trace_id] === stage.key }"
                  @click.stop="setActiveTab(trace.trace_id, stage.key)"
                >
                  {{ formatStageLabel(stage) }}
                </button>
              </div>
              <article v-for="(step, idx) in filteredSteps(trace)" :key="idx" class="step">
                <div class="step-head">
                  <div>
                    <span class="stage">{{ step.stage }}</span>
                    <span class="provider">{{ step.provider_id || 'n/a' }}</span>
                  </div>
                  <div class="step-meta">
                    <span
                      class="vision-flag"
                      :class="{ enabled: step.vision_supported }"
                    >
                      ğŸ–¼ï¸ {{ step.vision_supported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ' }}
                    </span>
                    <span class="image-count">å›¾ç‰‡ {{ step.image_count || (step.images ? step.images.length : 0) }}</span>
                    <small>{{ formatTs(step.ts) }}</small>
                  </div>
                </div>
                <div class="step-body">
                  <p class="status" v-if="step.error">âš  {{ step.error }}</p>
                  <p class="status" v-else>{{ summarizeDecisions(step.decisions) || preview(step.meta_summary || step.raw_output || step.raw_json) }}</p>
                  <details>
                    <summary>æŸ¥çœ‹ Prompt</summary>
                    <div class="prompt-block">
                      <h4>System</h4>
                      <pre>{{ step.system_prompt || '-' }}</pre>
                    </div>
                    <div class="prompt-block">
                      <h4>User</h4>
                      <pre>{{ step.user_prompt || '-' }}</pre>
                    </div>
                  </details>
                  <details>
                    <summary>æŸ¥çœ‹è¾“å‡º</summary>
                    <pre>{{ step.raw_output || step.raw_json || step.meta_summary || '-' }}</pre>
                  </details>
                  <div v-if="step.images && step.images.length" class="images">
                    <figure v-for="(img, i) in step.images" :key="i">
                      <img :src="img.data_uri" :alt="img.description || 'image'" />
                      <figcaption>{{ img.description || 'LLM è¾“å…¥å›¾' }}</figcaption>
                    </figure>
                  </div>
                </div>
              </article>
            </div>
          </transition>
        </div>
      </section>

      <section class="card positions">
        <div class="card-head">
          <h2>Freqtrade ä»“ä½</h2>
          <button @click="fetchPositions">åˆ·æ–°</button>
        </div>
        <div v-if="!positions.length" class="empty">æš‚æ— æŒä»“</div>
        <table v-else>
          <thead>
            <tr>
              <th>ID</th>
              <th>äº¤æ˜“å¯¹</th>
              <th>æ–¹å‘</th>
              <th>å…¥åœºä»·</th>
              <th>æ•°é‡</th>
              <th>ä»“ä½</th>
              <th>æ æ†</th>
              <th>æŒä»“æ—¶é•¿</th>
              <th>å¼€ä»“æ—¶é—´</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="pos in positions" :key="pos.trade_id">
              <td>{{ pos.trade_id }}</td>
              <td>{{ pos.symbol }}</td>
              <td>{{ pos.side }}</td>
              <td>{{ formatNumber(pos.entry_price) }}</td>
              <td>{{ formatNumber(pos.amount, 4) }}</td>
              <td>{{ formatNumber(pos.stake) }}</td>
              <td>{{ pos.leverage ? pos.leverage + 'x' : '-' }}</td>
              <td>{{ formatDuration(pos.holding_ms) }}</td>
              <td>{{ formatTs(pos.opened_at) }}</td>
              <td>
                <button
                  class="ghost"
                  @click="quickClose(pos)"
                  :disabled="isClosing(pos.trade_id)"
                >
                  {{ isClosing(pos.trade_id) ? 'å…³é—­ä¸­â€¦' : 'å¿«æ·å…³é—­' }}
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>
  <script src="/admin/app.js" defer></script>
</body>
</html>
